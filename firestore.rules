/**
  * @fileOverview
  * Core Philosophy: This ruleset enforces a strict user-ownership model for user-specific data and a business-ownership model for business-related data. Global configurations and system services are restricted to super admins.
  * Data Structure: The data is organized hierarchically, with user data nested under `/users/{userId}` and business data under `/businesses/{businessId}`. Subcollections like products and landing configurations are nested under their respective business.
  * Key Security Decisions:
  *   - User listing is disallowed for privacy, except for the super admin.
  *   - Business ownership is enforced for write operations on all business-related data, including nested subcollections.
  *   - Global configuration and system service management are limited to super admins.
  *   - Public read access is granted to business-related public data, including products in their catalog.
  */
 
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isSuperAdmin() {
      return request.auth.token.email == "allseosoporte@gmail.com";
    }

    function isBusinessOwner(businessId) {
      return isSignedIn() && request.auth.uid == businessId;
    }

    /**
    * @description Defines the security rules for user profiles.
    */
    match /users/{userId} {
      allow get: if isOwner(userId) || isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) || isSuperAdmin();
      allow delete: if isExistingOwner(userId) || isSuperAdmin();
    }

    /**
    * @description Defines the security rules for system service configurations.
    */
    match /systemServices/{serviceId} {
      allow read, write: if isSuperAdmin();
    }

    /**
    * @description Defines the security rules for platform modules.
    */
    match /modules/{moduleId} {
      allow read, write: if isSuperAdmin();
    }

    /**
    * @description Defines the security rules for global configuration settings.
    */
    match /globalConfig/system {
      allow get: if isSuperAdmin();
      allow list: if false;
      allow create, update, delete: if isSuperAdmin();
    }

    /**
    * @description Defines security rules for business documents and their subcollections.
    * This grants public read access and owner-only write access.
    */
    match /businesses/{businessId}/{allPaths=**} {
      allow read: if true;
      allow write: if isBusinessOwner(businessId);
    }
  }
}
