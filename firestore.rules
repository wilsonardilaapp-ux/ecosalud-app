/**
  * @fileOverview
  * Core Philosophy: This ruleset enforces a strict user-ownership model for user-specific data and a business-ownership model for business-related data. Global configurations and system services are restricted to super admins.
  * Data Structure: The data is organized hierarchically, with user data nested under `/users/{userId}`, business data under `/businesses/{businessId}`, and global configurations stored in `/globalConfig/system`.
  * Key Security Decisions:
  *   - User listing is disallowed for privacy, except for the super admin.
  *   - Business ownership is enforced for all write resources within a business (landing pages, contact forms, products, etc.).
  *   - Global configuration and system service management are limited to super admins.
  *   - Public read access is granted to business profiles and their subcollections (catalogs, landing pages).
  * Denormalization for Authorization: The `businessId` field is included in documents within subcollections (like `products`) to allow security rules to validate access without needing extra `get()` calls. This is an example of Authorization Independence.
  */
 

 rules_version = '2';
 service cloud.firestore {
  match /databases/{database}/documents {
 

    function isSignedIn() {
      return request.auth != null;
    }
 

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
 

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
 

    function isSuperAdmin() {
      return request.auth.token.email == "allseosoporte@gmail.com";
    }

    function isBusinessOwner(businessId) {
      return isSignedIn() && request.auth.uid == businessId;
    }

    /**
    * @description Defines the security rules for user profiles. Only the user themselves can read or modify their profile. The super admin can list all users.
    * @path /users/{userId}
    */
    match /users/{userId} {
      allow get: if isOwner(userId) || isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) || isSuperAdmin();
      allow delete: if isExistingOwner(userId) || isSuperAdmin();
    }
 

    /**
    * @description Defines the security rules for system service configurations. Only super admins can manage these configurations.
    * @path /systemServices/{serviceId}
    */
    match /systemServices/{serviceId} {
      allow get: if isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    /**
    * @description Defines the security rules for platform modules. Only super admins can manage these modules.
    * @path /modules/{moduleId}
    */
    match /modules/{moduleId} {
      allow get: if isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
 

    /**
    * @description Defines the security rules for global configuration settings. Only super admins can manage these settings.
    * @path /globalConfig/system
    */
    match /globalConfig/system {
      allow get: if isSuperAdmin();
      allow list: if false;
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
 

    /**
    * @description Defines security rules for business profiles and all their subcollections.
    * This setup grants public read access, which is essential for catalogs and landing pages.
    * Write access is strictly limited to the authenticated owner of the business.
    * @path /businesses/{businessId}
    * @principle Open read access for public-facing content, owner-only write access.
    */
    match /businesses/{businessId}/{allPaths=**} {
      allow read: if true;
      allow write: if isBusinessOwner(businessId);
    }
 
  }
}
