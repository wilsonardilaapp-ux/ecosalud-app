/**
  * @fileOverview
  * Core Philosophy: This ruleset enforces a strict user-ownership model for user-specific data and a business-ownership model for business-related data. Global configurations and system services are restricted to super admins.
  * Data Structure: The data is organized hierarchically, with user data nested under `/users/{userId}`, business data under `/businesses/{businessId}`, and global configurations stored in `/globalConfig/system`. Products are stored in a root-level collection `/products`.
  * Key Security Decisions:
  *   - User listing is disallowed for privacy, except for the super admin.
  *   - Business ownership is enforced for write operations (businessId must match userId).
  *   - Global configuration and system service management are limited to super admins.
  *   - Public read access is granted to products and business-related public data.
  * Denormalization for Authorization: The `Product` collection includes a `businessId` field. This allows security rules to validate write access based on ownership without needing extra `get()` calls.
  */
 
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isSuperAdmin() {
      return request.auth.token.email == "allseosoporte@gmail.com";
    }

    function isBusinessOwner(businessId) {
      return isSignedIn() && request.auth.uid == businessId;
    }

    function isProductOwner() {
        let businessId = request.resource.data.businessId;
        return isSignedIn() && request.auth.uid == businessId;
    }

    function isExistingProductOwner() {
        let businessId = resource.data.businessId;
        return isSignedIn() && request.auth.uid == businessId;
    }


    /**
    * @description Defines the security rules for user profiles.
    */
    match /users/{userId} {
      allow get: if isOwner(userId) || isSuperAdmin();
      allow list: if isSuperAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) || isSuperAdmin();
      allow delete: if isExistingOwner(userId) || isSuperAdmin();
    }

    /**
    * @description Defines the security rules for system service configurations.
    */
    match /systemServices/{serviceId} {
      allow read, write: if isSuperAdmin();
    }

    /**
    * @description Defines the security rules for platform modules.
    */
    match /modules/{moduleId} {
      allow read, write: if isSuperAdmin();
    }

    /**
    * @description Defines the security rules for global configuration settings.
    */
    match /globalConfig/system {
      allow get: if isSuperAdmin();
      allow list: if false;
      allow create, update, delete: if isSuperAdmin();
    }

    /**
    * @description Defines security rules for the root products collection.
    * This allows public reading of individual documents, authenticated listing, and owner-only writes.
    */
    match /products/{productId} {
      allow get: if true; // Allows public catalog to get single products
      allow list: if isSignedIn(); // Allows authenticated users (dashboard) to query the collection
      allow create: if isProductOwner();
      allow update, delete: if isExistingProductOwner();
    }

    /**
    * @description Defines security rules for business documents and their subcollections.
    * This grants public read access and owner-only write access.
    */
    match /businesses/{businessId}/{allPaths=**} {
      allow read: if true;
      allow write: if isBusinessOwner(businessId);
    }
  }
}
